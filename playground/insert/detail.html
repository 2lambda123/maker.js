<!DOCTYPE html>
<html>

<head>
    <title>Maker.js Playground Javascript Insert</title>
    <meta charset="utf-8" />
    <meta name="viewport" content="user-scalable=no, width=device-width, initial-scale=1, maximum-scale=1">

    <!--

    *****************************************************************************
    Copyright (c) Microsoft Corporation. All rights reserved.
    Licensed under the Apache License, Version 2.0 (the "License"); you may not use
    this file except in compliance with the License. You may obtain a copy of the
    License at http://www.apache.org/licenses/LICENSE-2.0

    THIS CODE IS PROVIDED ON AN *AS IS* BASIS, WITHOUT WARRANTIES OR CONDITIONS OF ANY
    KIND, EITHER EXPRESS OR IMPLIED, INCLUDING WITHOUT LIMITATION ANY IMPLIED
    WARRANTIES OR CONDITIONS OF TITLE, FITNESS FOR A PARTICULAR PURPOSE,
    MERCHANTABLITY OR NON-INFRINGEMENT.

    See the Apache Version 2.0 License for specific language governing permissions
    and limitations under the License.
    *****************************************************************************

    https://github.com/Microsoft/maker.js

    -->

    <link href="insert.css" rel="stylesheet" />

    <script>
        var makerjs = parent.makerjs;

        function doFocus() {
            document.querySelector('form').elements[0].focus();
        }

        var details = {
            "script": {
                "if statement": {
                    inputs: [
                        { title: "condition", type: "text", value: "condition" },
                        { title: "has else", type: "bool" }
                    ],
                    template: function (condition, hasElse) {
                        return `if (${condition}) {\n\n}${hasElse ? ` else {\n\n}` : ''}`;
                    }
                },
                "local function": {
                    inputs: [
                        { title: "function name", type: "text", value: "myFunction" }
                    ],
                    template: function (name) {
                        return `function ${name} () {\n\n}`;
                    }
                },
                "for loop": {
                    inputs: [
                        { title: "variable name", type: "text", value: "i" },
                        { title: "start", type: "text", value: "0" },
                        { title: "end", type: "text", value: "10" }
                    ],
                    template: function (i, start, end) {
                        return `for (var ${i} = ${start}; ${i} < ${end}; ${i}++) {\n\n}`;
                    }
                }
            },
            "paths": {
                "Arc": {
                    inputs: [
                        { title: "origin", type: "text", value: "[0, 0]" },
                        { title: "radius", type: "text", value: "10" },
                        { title: "start angle", type: "text", value: "0" },
                        { title: "end angle", type: "text", value: "180" }
                    ],
                    template: function (origin, radius, startAngle, endAngle) {
                        return `makerjs.$(new makerjs.paths.Arc(${origin}, ${radius}, ${startAngle}, ${endAngle})).addTo(this);`;
                    }
                },
                "Circle": {
                    inputs: [
                        { title: "origin", type: "text", value: "[0, 0]" },
                        { title: "radius", type: "text", value: "10" }
                    ],
                    template: function (origin, radius) {
                        return `makerjs.$(new makerjs.paths.Circle(${origin}, ${radius})).addTo(this);`;
                    }
                },
                "Line": {
                    inputs: [
                        { title: "origin", type: "text", value: "[0, 0]" },
                        { title: "end", type: "text", value: "[20, 20]" }
                    ],
                    template: function (origin, end) {
                        return `makerjs.$(new makerjs.paths.Line(${origin}, ${end})).addTo(this);`;
                    }
                }
            },
            "models": (function () {
                var models = {};

                for (var id in makerjs.models) {
                    if (id === 'Text') continue;    //TODO get font
                    models[id] = getModel(id)
                }

                return models;
            })()
        };

        function getModel(id) {
            return {
                inputs: makerjs.models[id].metaParameters,
                template: function () {
                    var args = [].slice.call(arguments);
                    return `makerjs.$(new makerjs.models.${id}(${args.join(', ')})).addTo(this);`;
                }
            };
        }

        var selectedDetail;

        window.onload = function () {
            var groupParam = queryStringParams['group'];
            var idParam = queryStringParams['id'];
            if (groupParam && idParam) {
                var group = details[groupParam];
                if (group) {
                    var detail = group[idParam];
                    if (detail) {
                        selectedDetail = detail;
                        showDetail();
                        return;
                    }
                }
            }
            //showError();
        }

        document.addEventListener("keydown", function (e) {
            switch (e.key) {
                case 'Enter':
                    return e.ctrlKey && parent.MakerJsPlayground.command('run');
                case 'Escape':
                    return parent.MakerJsPlayground.command('toggle', 'collapse-insert-menu');
                case 'i':
                    return e.ctrlKey && parent.MakerJsPlayground.command('toggle', 'collapse-insert-menu');
                case 'z':
                    return e.ctrlKey && parent.MakerJsPlayground.command('undo');
            }
        });

        function QueryStringParams(querystring) {
            if (querystring === void 0) { querystring = document.location.search.substring(1); }
            if (querystring) {
                var pairs = querystring.split('&');
                for (var i = 0; i < pairs.length; i++) {
                    var pair = pairs[i].split('=');
                    this[pair[0]] = decodeURIComponent(pair[1]);
                }
            }
        }

        var queryStringParams = new QueryStringParams();

        function convertInput(input) {
            var textbox = checkbox = '';
            var value = input.value;
            switch (input.type) {
                case 'select':
                    value = JSON.stringify(value[0]);
                case 'range':
                case 'text':
                    value = typeof value !== 'undefined' ? value : '';
                    textbox = `<input type='text' onfocus="this.setSelectionRange(0, this.value.length)" onkeyup="getInputs()" value="${value}" onchange="getInputs()" />`;
                    break;

                case 'bool':
                    checkbox = `<input type='checkbox' ${input.checked ? 'checked' : ''}" onchange="getInputs()" /> `;  //keep trailing space
                    break;
            }
            return `<div><label>${checkbox}${input.title}<label/>${textbox}</div>`;
        }

        function showDetail() {
            var form = document.querySelector('form');
            var inputs = selectedDetail.inputs.map(convertInput);

            //add 2 elements
            inputs.push(`<div><label><input type='checkbox' id="newlines" onchange="getInputs()"/> add newlines<label/></div>`);
            inputs.push(`<div><input type='submit' value="&#x2295; insert at cursor"/></div>`);

            form.innerHTML = inputs.join('');
            setTimeout(function () {
                form.elements[0].focus();
                getInputs();
            }, 0);
        }

        function getInputValue(element) {
            if (element.type === 'checkbox') {
                return element.checked;
            }

            var num = parseFloat(element.value);
            if (!isNaN(num)) {
                return num;
            }

            try {
                var parsed = JSON.parse(element.value);
                if (Array.isArray(parsed)) {
                    return element.value;
                }
            }
            catch (e) { }

            //TODO return JSON.stringify for text params
            
            return element.value;
        }

        function getInputs() {
            var form = document.querySelector('form');
            var elements = [].slice.call(form.elements).slice(0, -2);   //remove the 2 added elements
            var values = elements.map(getInputValue);
            var preview = document.querySelector('#preview');
            var output = [selectedDetail.template.apply(null, values)];
            if (form.elements.newlines.checked) {
                output.unshift('\n');
                output.push('\n\n');
            }
            preview.innerText = output.join('');
        }
    </script>

</head>

<body>
    <main>

        <button id="back" onclick="history.back()">&#x25C0; back</button>

        <h2>
            <script>
                document.write(queryStringParams['id']);
            </script>
        </h2>

        <section class="input">
            <form onsubmit="parent.MakerJsPlayground.command('insert', document.querySelector('#preview').innerText);return false;"></form>
        </section>

        <section class="preview">
            <label>preview</label>
            <div id="preview"></div>
        </section>

    </main>

</body>

</html>